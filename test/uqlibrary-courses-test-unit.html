<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>uqlibrary-timeline</title>

  <script src="../../webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../uqlibrary-courses.html">
</head>
<body>

<uqlibrary-courses autoload="false"></uqlibrary-courses>

<script>
  window.addEventListener('polymer-ready', function() {
    var coursesEl = document.querySelector('uqlibrary-courses');

    var courses = [
      {
        "ACAD_CAREER": "UGRD",
        "DESCR": "Financial Management",
        "SUBJECT": "FINM",
        "CATALOG_NBR": "2401",
        "CAMPUS": "STLUC",
        "INSTRUCTION_MODE": "IN",
        "ACAD_GROUP": "BEL",
        "STRM":"6460",
        "learning_resources":
          {
            reading_lists: {
              "title": "FINM2401 St Lucia",
              "campus": "St Lucia",
              "url": "http://lr.library.uq.edu.au/lists/5C8C5165-7429-DD81-2CD4-906E945EC3F2",
              "period": "Semester 2 2015",
              items:   [
                {
                  "referenceType": "Webpage",
                  "title": "Past Central Exam Papers",
                  "notes": "Follow the link and search for past exam papers by course code.",
                  "url": "https://www.library.uq.edu.au/#exampapers",
                  "itemLink": "http://lr.library.uq.edu.au/items/1A95B6A1-B629-8D60-115D-5F8812DF30FC.html"
                },
                {
                  "referenceType": "Book",
                  "title": "System analysis and design",
                  "importance": "Required",
                  "author": "Dennis, Alan; Wixom, Barbara Haley; Roth, Roberta M.",
                  "publisher": "John Wiley",
                  "year": "c2012",
                  "placePublished": "Hoboken, NJ",
                  "isbn": "1118057627; 9781118057629",
                  "catalogueRecordId": "b3117929",
                  "itemLink": "http://lr.library.uq.edu.au/items/3265CA51-C19F-5F29-AAED-3E6EF5270ED5.html"
                }
              ]
            },
            exam_papers: [
              {
                "url": "https://www.library.uq.edu.au/pdfserve.php?image=1302/2013_2_FINM2401_s.pdf",
                "period": "Semester 2 2013",
                "course": "FINM2401"
              },
              {
                "url": "https://www.library.uq.edu.au/pdfserve.php?image=1301/2013_1_FINM2401_s.pdf",
                "period": "Semester 1 2013",
                "course": "FINM2401"
              }
            ]
          },
        "library_guides":[
          {
            "title": "Company and Industry Information",
            "url": "http://guides.library.uq.edu.au/company-information?hs=a"
          },
          {
            "title": "Finance",
            "url": "http://guides.library.uq.edu.au/finance?hs=a"
          }
        ]
      },
      {
        "ACAD_CAREER": "UGRD",
        "DESCR": "Elect Commerce Systems Dev",
        "SUBJECT": "INFS",
        "CATALOG_NBR": "2244",
        "CAMPUS": "STLUC",
        "INSTRUCTION_MODE": "IN",
        "ACAD_GROUP": "BEL",
        "STRM":"6460"
      }
    ];
    var term_dates = {
      "6460": {
        "code": "6460",
        "begin": "2014-07-07",
        "end": "2014-12-31",
        "cut_off": "2014-08-31"
      },
      "6520": {
        "code": "6460",
        "begin": "2014-07-07",
        "end": "2014-12-31",
        "cut_off": "2014-08-31"
      }

    };

    var courseLoadedEventListeners = [];

    describe('uqlibrary-courses', function () {
      before(function () {
      });

      afterEach(function () {

        //remove all previous listeners
        for(var i=0; i< courseLoadedEventListeners.length; i++) {
          coursesEl.removeEventListener('uqlibrary-courses-loaded', courseLoadedEventListeners[i]);
        }
      });

      describe('no courses loaded', function () {
        it('should display default card if no courses loaded', function(done) {
          coursesEl.courses = [];
          var noCoursesListener = function() {
            // check block visibility asynchronously
            setTimeout(function() {
              var processedCourses = coursesEl.processedCourses;
              expect(processedCourses).to.be.empty.and.not.to.be.null;

              var noCoursesMessage = coursesEl.shadowRoot.querySelector('#noCoursesMessage');
              var isHidden = noCoursesMessage.getAttribute('hidden');
              assert.isNull(isHidden, 'noCoursesMessage is hidden');
              coursesEl.removeEventListener('uqlibrary-courses-loaded');
              done();
            }, 0);
          };
          coursesEl.addEventListener('uqlibrary-courses-loaded', noCoursesListener);
          courseLoadedEventListeners.push(noCoursesListener);
        });

      });

      describe('courses', function () {
        it('should display tabs with courses', function(done) {
          coursesEl.termExtendWeeksRange = {before: 520, after: 520}; // +- 10 years to make sure courses are loaded
          coursesEl.$.term_dates.get = function(code){coursesEl.processData()};
          coursesEl.courses = courses;
          coursesEl.termDates = term_dates;
          var coursesLoadListener = function() {
            setTimeout(function() {
              // Check courses to be loaded correctly
              expect(coursesEl.processedCourses).to.have.length(courses.length);

              // check tabs are shown
              var tabs = coursesEl.$.tabs.querySelectorAll('paper-tab');
              assert.isNotNull(tabs, 'Tabs are not visible');
              // Check all tabs courses are shown
              expect(tabs.length).to.be.equal(coursesEl.processedCourses.length);

              // Check the first tab
              expect(tabs[0].getAttribute('name')).to.be.equal(coursesEl.processedCourses[0].SUBJECT + coursesEl.processedCourses[0].CATALOG_NBR);

              // get the first tab
              coursesEl.get();
              //coursesEl.selectedTab = ;

              // Wait 2 second for mock data to be loaded
              setTimeout(function() {

                var courseTab = coursesEl.shadowRoot.querySelector('#'+courses[0].SUBJECT +courses[0].CATALOG_NBR + ' uqlibrary-course');
                assert.isNotNull(courseTab, 'First course tab is not visible');

                // Get course cards
                var courseCards = courseTab.shadowRoot.querySelectorAll('swipeable-card');
                expect(courseCards.length).to.be.equal(5); // 5 cards must be displayed

                // Check each card
                for (var i=0; i < courseCards.length; i++) {
                  var _id = courseCards[i].getAttribute('id');
                  var _titleElement = courseCards[i].querySelector('.cardSection.cardTitle');
                  switch(_id) {
                    case 'readingListCard':
                      assert.isNotNull(_titleElement, 'Card title missed for reading list card');
                      expect(_titleElement.innerHTML).to.contain('('+ coursesEl.courses[0].learning_resources.reading_lists.items.length +')')
                      var _visibleItems = courseCards[i].querySelectorAll('.cardSection .listItemSection.listItemTitle');
                      expect(_visibleItems.length).to.be.equal(courseTab.readingList.length);
                      break;
                    case 'examPapersCard':
                      assert.isNotNull(_titleElement, 'Card title missed for exam papers card');
                      expect(_titleElement.innerHTML).to.contain('('+ coursesEl.courses[0].learning_resources.exam_papers.length +')')
                      var _visibleItems = courseCards[i].querySelectorAll('#examPaperItems .cardSection .listItemLink');
                      expect(_visibleItems.length).to.be.equal(courseTab.examPapers.length);
                      break;
                    case 'libraryGuidesCard':
                      assert.isNotNull(_titleElement, 'Card title missed for library guides card');
                      expect(_titleElement.innerHTML).to.contain('('+ coursesEl.courses[0].library_guides.length +')')
                      var _visibleItems = courseCards[i].querySelectorAll('#libGuidesItems .cardSection .listItemLink');
                      expect(_visibleItems.length).to.be.equal(courseTab.libGuides.length);
                      break;
                    case 'ecpCard':
                      assert.isNotNull(_titleElement, 'Card title missed for electronic course profile card');
                      // Check if link to course profile is correct
                      var _link = courseCards[i].querySelector('a.link');
                      expect(_link.getAttribute('href')).to.contain(courses[0].SUBJECT +courses[0].CATALOG_NBR);
                      break;
                    case 'studyLinksCard':
                      var _studyLinks = courseCards[i].querySelector('uqlibrary-courses-study-links');
                      expect(_studyLinks).not.to.be.null;
                      break;
                    default:
                      break;
                  }
                }

                //setTimeout(function(){
                //coursesEl.selectedTab = 'INFS2244';
                // coursesEl.togglePanel();
                // coursesEl.$.noCoursesMessage.removeAttribute('hidden')

                done();


                // }, 2000);


              }, 2000);

            }, 0);
          };
          coursesEl.addEventListener('uqlibrary-courses-loaded', coursesLoadListener);

        });
      });

    });

  });
</script>

</body>
</html>

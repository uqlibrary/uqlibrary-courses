<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">
<link rel="import" href="uqlibrary-courses-study-links.html">

<polymer-element name="uqlibrary-course" layout center attributes="course">
  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
    <uqlibrary-ga id="ga" appName="Courses"></uqlibrary-ga>

    <div id="cards">
      <swipeable-card class="card" id="readingListCard">
        <paper-shadow z="1">
          <div class="subhead cardSection cardTitle">Reading List <span hidden?="{{course.learning_resources.multipleReadingLists}}">({{course.learning_resources.reading_lists.items.length}})</span></div>

          <div hidden?="{{readingList.length > 0}}">
            <div class="body1 cardSection" hidden?={{course.learning_resources.multipleReadingLists}}>
              <div class="caption listItemSection listItemNoResultsMessage">
                No reading lists for this course
              </div>
            </div>
            <div class="body1 cardSection" hidden?={{!course.learning_resources.multipleReadingLists}}>
              <div class="listItemSection">
                More than one reading list found for {{course.courseId}}. Please select a list:
               </div>
            </div>
            <template repeat="{{item in course.learning_resources.multipleReadingLists }}">
              <a href="{{item.url}}" target="_blank" on-click="{{linkClicked}}" id="specifyReadingList">
                <div class="body1 cardSection">
                  <div class="link listItemSection listItemTitle">{{item.title}}</div>
                  <div class="caption listItemSection listItemAuthor">{{item.period}}</div>
                </div>
              </a>
            </template>

            <a class="link" href="{{readingListsSearchUrl}}" target="_blank">
              <div class="cardSection">
                <div class="link listItemLink">
                  <core-icon class="link" icon="arrow-forward"></core-icon> Search other reading lists
                </div>
              </div>
            </a>
          </div>

          <template repeat="{{item in readingList }}">
            <a href="{{item.itemLink}}" target="_blank" on-click="{{linkClicked}}" id="readingListItem">
              <div class="body1 cardSection">
                <div class="link listItemSection listItemTitle">{{item.title}}</div>
                <div class="caption listItemSection listItemAuthor" hidden?="{{!item.author}}">
                <i>{{item.author}} {{item.year}} </i>
              </div>

              <div class="caption listItemSection listItemNotes" hidden?="{{!item.notes && (!item.startPage || !item.endPage)}}">
              <span hidden?="{{!item.startPage || !item.endPage}}">Pages from {{item.startPage}} to {{item.endPage}}<br></span>
              {{item.notes | trimNotes}}
              </div>

              <div class="caption listItemSection listItemType">{{item.referenceType}} <span hidden?="{{!item.importance}}">- {{item.importance}}</span></div>
              </div>
            </a>
          </template>
          <a class="link" href="{{course.learning_resources.reading_lists.url}}" on-click="{{linkClicked}}" id="readingListMoreItems" target="_blank" hidden?="{{course.moreItemsCount.readingLists == 0}}">
          <div class="cardSection noBorder">
            <div class="link listItemLink">
              <core-icon class="link" icon="arrow-forward"></core-icon> {{course.moreItemsCount.readingLists}} more {{course.moreItemsCount.readingLists == 1 ? 'item' : 'items'}}
            </div>
          </div>
          </a>
      </paper-shadow>
    </swipeable-card>

    <swipeable-card class="card" id="examPapersCard">
      <paper-shadow z="1">
        <div class="subhead cardSection cardTitle">Past Exam Papers ({{course.learning_resources.exam_papers.length}})</div>

        <div class="body1 cardSection" hidden?="{{examPapers.length > 0}}">
        <div class="caption listItemSection listItemNoResultsMessage">
          No Past Exam Papers for this course
        </div>
        </div>
        <a class="link" href="{{examPapersSearchUrl}}" target="_blank" hidden?="{{examPapers.length > 0}}" >
        <div class="cardSection">
          <div class="link listItemLink">
            <core-icon class="link" icon="arrow-forward"></core-icon> Search for other exam papers
          </div>
        </div>
        </a>
        <div id="examPaperItems">
          <template repeat="{{ paper in examPapers }}">
            <a class="link" href="{{paper.url}}" target="_blank" on-click="{{linkClicked}}" id="examPaperItem">
              <div class="cardSection" >
                <div class="link listItemLink">
                  {{paper.period}} ({{paper.url | extractExtension}})
                </div>
              </div>
            </a>
          </template>
        </div>
        <a class="link" href="{{examPapersSearchUrl + course.courseId}}" on-click="{{linkClicked}}" id="examPapersMoreItems" target="_blank" hidden?="{{course.moreItemsCount.examPapers == 0}}">
        <div class="cardSection noBorder">
          <div class="link listItemLink">
            <core-icon class="link" icon="arrow-forward"></core-icon> {{course.moreItemsCount.examPapers}} more past exam {{course.moreItemsCount.examPapers == 1 ? 'paper' : 'papers'}}
          </div>
        </div>
        </a>
      </paper-shadow>
    </swipeable-card>

    <swipeable-card class="card" id="libraryGuidesCard">
      <paper-shadow z="1">
        <div class="subhead cardSection cardTitle">Library Guides</div>

        <div class="body1 cardSection" hidden?="{{libGuides.length > 0}}">
          <div class="caption listItemSection listItemNoResultsMessage">
            No Library guides for this course
          </div>
        </div>
        <div id="libGuidesItems">
          <template repeat="{{ guide in libGuides }}">
            <a class="link" href="{{guide.url}}" target="_blank" on-click="{{linkClicked}}" id="libraryGuideItem">
              <div class="cardSection" >
                <div class="link listItemLink">
                  {{guide.title}}
                </div>
              </div>
            </a>
          </template>
        </div>

        <div class="cardSection noBorder">
          <div class="link listItemLink">
            <a class="link" href="{{libGuidesLinkUrl}}" target="_blank" on-tap="{{linkClicked}}" id="allLibraryGuides">
              <core-icon class="link" icon="arrow-forward" id="arrow-icon"></core-icon> All Library Guides
            </a>
          </div>
        </div>
      </paper-shadow>
    </swipeable-card>

    <swipeable-card class="card" id="ecpCard">
      <paper-shadow z="1">
        <div class="subhead cardSection cardTitle">Course Links</div>
        <a class="link" href="{{ecpLinkUrl + course.courseId}}" target="_blank" on-click="{{linkClicked}}" id="electronicCourseProfile">
          <div class="cardSection">
            <div class="link listItemLink">
              <core-icon class="link" icon="arrow-forward"></core-icon> Electronic Course Profile
            </div>
          </div>
        </a>
        <a class="link" on-click="{{linkClicked}}" id="blackboard" href="https://learn.uq.edu.au/{{course.courseId}}" target="_blank">
          <div class="cardSection noBorder">
            <div class="link listItemLink">
              <core-icon class="link" icon="arrow-forward" id="extension-icon"></core-icon> Learn.UQ (Blackboard)
            </div>
          </div>
        </a>

      </paper-shadow>
    </swipeable-card>

    <swipeable-card class="card" id="studyLinksCard">
      <paper-shadow z="1">
        <uqlibrary-courses-study-links course="{{course}}"></uqlibrary-courses-study-links>
      </paper-shadow>
    </swipeable-card>

    </div>
  </template>

  <script>
    Polymer('uqlibrary-course', {

      /**
       * The `courses` attribute contains information about courses
       *
       * @property data
       * @type Object
       */

      publish: {
        course: {
          learning_resources: {
            reading_lists: [],
            exam_papers: []
          },
          library_guides: []
        }
      },
      observe: {
        'course.learning_resources.reading_lists.items': 'courseReadingListItemsChanged',
        'course.learning_resources.exam_papers': 'courseExamPapersChanged',
        'course.library_guides': 'libraryGuidesChanged'
      },

      readingList:[],
      examPapers:[],
      libGuides: [],

      notesTrimLength: 90,
      visibleItemsCount: {
        readingLists: 2,
        examPapers: 2,
        libGuides: 3
      },
      examPapersSearchUrl: 'https://www.library.uq.edu.au/exams/papers.php?stub=',
      ecpLinkUrl: 'http://www.uq.edu.au/study/course.html?course_code=',
      libGuidesLinkUrl: 'http://guides.library.uq.edu.au',
      libGuidesBrowseUrl: 'http://guides.library.uq.edu.au/browse.php',
      readingListsSearchUrl: 'http://lr.library.uq.edu.au/index.html',


      ready: function() {
        this.course.moreItemsCount = {
          readingLists: 0,
          examPapers: 0,
          libGuides: 0
        };

        var that = this;
        this.$.cards.addEventListener('swipeable-card-swipe-away', function(e) {

          e.target.parentNode.removeChild(e.target); // removes this card
          that.$.cards.appendChild(e.target); // adds this card to the end of the set of cards
          e.target.style.opacity = 1;
          e.target.style.transform = "translate3d(0px, 0px, 0px) rotate(0deg)";
          e.target.style.webkitTransform = "translate3d(0px, 0px, 0px) rotate(0deg)";

          that.$.ga.addEvent('Course Card Swiped Away', e.target.getAttribute('id'));
        });
      },

      created: function() {
      },

      extractExtension: function(url) {
        return url.substring(url.lastIndexOf('.')+1);
      },

      trimNotes: function(value) {
        if(value && value.length > this.notesTrimLength) {
          var _trimmed = value.substring(0, this.notesTrimLength);
          // trim on word boundary
          _trimmed = _trimmed.substring(0, _trimmed.lastIndexOf(' '));
          return (_trimmed + '...');
        }
        else
          return value;
      },

      courseReadingListItemsChanged: function(oldValue, newValue) {
        if(newValue) {
          // slice reading list array to show limited number items
          if(this.visibleItemsCount.readingLists && this.visibleItemsCount.readingLists > 0 && newValue.length >= this.visibleItemsCount.readingLists) {
            this.readingList = newValue.slice(0, this.visibleItemsCount.readingLists);
            this.course.moreItemsCount.readingLists = newValue.length - this.visibleItemsCount.readingLists;
          }
          else{
            this.readingList = newValue;
            this.course.moreItemsCount.readingLists = 0;
          }
        }
      },

      courseExamPapersChanged: function(oldValue, newValue) {
        if(newValue) {
          // slice reading list array to show limited number items
          if(this.visibleItemsCount.examPapers && this.visibleItemsCount.examPapers > 0 && newValue.length >= this.visibleItemsCount.examPapers) {
            this.examPapers = newValue.slice(0, this.visibleItemsCount.examPapers);
            this.course.moreItemsCount.examPapers = newValue.length - this.visibleItemsCount.examPapers;
          }
          else{
            this.examPapers = newValue;
            this.course.moreItemsCount.examPapers = 0;
          }
        }
      },

      libraryGuidesChanged: function(oldValue, newValue) {
        if(newValue) {
          // slice reading list array to show limited number items
          if(this.visibleItemsCount.libGuides && this.visibleItemsCount.libGuides > 0 && newValue.length > this.visibleItemsCount.libGuides) {
            this.libGuides = newValue.slice(0, this.visibleItemsCount.libGuides);
            this.course.moreItemsCount.libGuides = newValue.length - this.visibleItemsCount.libGuides;
          }
          else{
            this.libGuides = newValue;
            this.course.moreItemsCount.libGuides = 0;
          }
        }
      },

      linkClicked: function(e, detail, sender) {
        var _id = sender.getAttribute('id');
        if(_id) {
          this.$.ga.addEvent('Link Clicked', _id);
        }
      }

    });
  </script>

</polymer-element>
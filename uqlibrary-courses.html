<!--
Element providing an overview for student's courses

##### Example

    <uqlibrary-courses></uqlibrary-courses>

    <script>
    (function () {

      window.addEventListener('polymer-ready', function() {

        var courses = document.querySelector('uqlibrary-courses');

        courses.courses = [
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Financial Management",
              "SUBJECT": "FINM",
              "CATALOG_NBR": "2401",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Elect Commerce Systems Dev",
              "SUBJECT": "INFS",
              "CATALOG_NBR": "2244",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Working with Groups & Teams",
              "SUBJECT": "MGTS",
              "CATALOG_NBR": "2961",
              "CAMPUS": "GATTN",
              "INSTRUCTION_MODE": "EX",
              "ACAD_GROUP": "SCI"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Financial Reporting",
              "SUBJECT": "ACCT",
              "CATALOG_NBR": "2101",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            },
            {
              "ACAD_CAREER": "UGRD",
              "DESCR": "Elect Com Infrastructure Mgmt",
              "SUBJECT": "MGTS",
              "CATALOG_NBR": "3204",
              "CAMPUS": "STLUC",
              "INSTRUCTION_MODE": "IN",
              "ACAD_GROUP": "BEL"
            }
          ];
      });
    }());
  </script>

@element uqlibrary-courses
@blurb Element providing an overview for student's courses
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-courses
-->

<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">

<link rel="import" href="uqlibrary-course.html">
<link rel="import" href="uqlibrary-courses-study-links.html">


<polymer-element name="uqlibrary-courses" layout center attributes="courses autoload">
  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
    <core-signals on-core-signal-transitioning-change="{{transitioningChangeHandler}}"></core-signals>
    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-learning-resources id="learning_resources"></uqlibrary-api-learning-resources>
    <uqlibrary-api-course-reading-list id="reading_list"></uqlibrary-api-course-reading-list>
    <uqlibrary-api-library-guides id="library_guides"></uqlibrary-api-library-guides>
    <uqlibrary-api-term-dates id="term_dates"></uqlibrary-api-term-dates>

    <uqlibrary-ga id="ga" appName="Courses"></uqlibrary-ga>

    <core-drawer-panel id="drawerPanel" class="drawer" drawerWidth="256px" responsiveWidth="768px">
      <core-header-panel drawer>
        <uqlibrary-menu account="{{user}}"></uqlibrary-menu>
      </core-header-panel>

      <core-header-panel main class="main">
        <core-toolbar>
          <core-a11y-keys id="a11yToolBarLeftButton" target="{{$.toolBarLeftButton}}" keys="{{keyboardNavigationKeys}}"
                          on-keys-pressed="{{ a11yKeyPressed }}"></core-a11y-keys>
          <paper-icon-button id="toolBarLeftButton" icon="menu" core-drawer-toggle></paper-icon-button>
          <h1 flex id="toolbar-page-title">My courses</h1>
        </core-toolbar>

        <div id="content">

          <div id="noCoursesMessage" hidden?="{{ processedCourses == null || processedCourses.length > 0 }}">
            <paper-shadow class="card" z="1">
              <div class="subhead cardSection cardTitle">Courses will be shown 3 weeks prior to the start of semester</div>
              <div class="caption cardSection ">Please check back closer to the next enrollment period</div>
            </paper-shadow>
          <paper-shadow z="1" class="card">
            <uqlibrary-courses-study-links></uqlibrary-courses-study-links>
          </paper-shadow>
          </div>


          <paper-tabs id="tabs" selected="{{ selectedTab }}" on-core-select="{{ tabSelected }}" hidden?="{{processedCourses.length == 0}}">
            <template repeat="{{ processedCourses as course }}">
              <paper-tab name="{{ course.courseId }}" id="course{{course.courseId}}" aria-label="{{ course.SUBJECT }} {{ course.CATALOG_NBR }}">
                <div class="menu">
                  <uqlibrary-a11y-link>
                    <div class="tabTitle" layout vertical center>{{ course.SUBJECT }}</div>
                    <div class="tabTitle" layout vertical center>{{ course.CATALOG_NBR }}</div>
                  </uqlibrary-a11y-link>
                </div>
              </paper-tab>
            </template>
          </paper-tabs>

          <core-overlay id="loadingOverlay"
                        layout
                        horizontal
                        opened?="{{!transitioning && processedCourses.length > 0 && (!selectedCourse.learning_resources.reading_lists.items || !selectedCourse.learning_resources.exam_papers || !selectedCourse.library_guides) }}">
            <div flex self-center center-justified layout horizontal>
              <paper-spinner active></paper-spinner>
            </div>
          </core-overlay>

          <core-animated-pages id="animatedPages" transitions="slide-from-right" block selected="{{selectedTab}}"
                               on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                               on-core-animated-pages-transition-end="{{transitionEndHandler}}"
                               hidden?="{{processedCourses.length == 0}}"
          >

          <template repeat="{{ processedCourses as course }}">
            <section id="{{ course.courseId }}" name="{{ course.courseId }}">
              <uqlibrary-course course="{{course}}" hidden?="{{!course.learning_resources.reading_lists.items || !course.learning_resources.exam_papers || !course.library_guides}}"></uqlibrary-course>
            </section>
          </template>
          </core-animated-pages>
        </div>
      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    Polymer('uqlibrary-courses', {

      // Accessibility issues fixes

      keyboardNavigationKeys: 'space enter',

      a11yKeyPressed: function(source, event) {
        if (source.path && source.path.length > 0 && source.path[0].target) {
          source.path[0].target.fire("tap");
        }
      },

      /**
       * The `courses` attribute contains information about courses
       *
       * @property courses
       * @type Object
       */
      publish: {
        courses: null,
        autoload: true
      },
      selectedTab: '',
      learningResources: {},
      processedCourses: null,
      termDates: {},
      selectedCourse: {},
      transitioning: false,
      user: {},

      // Extend search dates for courses
      termExtendWeeksRange: {
        before: 3,
        after: 1
      },

      togglePanel: function () {
        this.$.drawerPanel.togglePanel();
      },

      ready: function() {
        var that = this;
        var courseIndex = null;


        this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
          if (e.detail.hasSession) {
            if(e.detail.classes) {
              that.user = e.detail;
              that.courses = e.detail.classes;
            }
          } else {
            // Not logged in
            that.$.account.login(window.location.href);
          }
        });
        if(this.autoload){
          this.$.account.get();
        }

        this.addEventListener('uqlibrary-courses-loaded', function(){
          this.get();
        });

        this.$.learning_resources.addEventListener('uqlibrary-api-learning-resources', function(e) {

          if(e.detail.length > 0) {
            for(var i = 0; i < that.processedCourses.length; i++) {

              for(var j = 0; j < e.detail.length; j++ ) {
                if(that.processedCourses[i].courseId == e.detail[j].title) {
                  that.processedCourses[i]['learning_resources'] = e.detail[j];

                  that.filterReadingLists(that.processedCourses[i]);
                  that.filterExamPapers(that.processedCourses[i]);
                  var readingListId = that.getReadingListId(that.processedCourses[i].learning_resources.reading_lists);

                  if(readingListId != '') {
                    courseIndex = i;
                    that.$.reading_list.get( {code: readingListId} );
                  }
                  else if(that.processedCourses[i].learning_resources.hasOwnProperty('multipleReadingLists')) {

                  }
                  //finish iterating
                  j = e.detail.length;
                }
              }
            }
          }
          else {
            if(that.selectedTab) {
              for(var i = 0; i < that.processedCourses.length; i++) {
                if(that.processedCourses[i].courseId == that.selectedTab) {
                  that.processedCourses[i]['learning_resources'] = {reading_lists : {items: []}, exam_papers: []};
                }
              }
            }
          }
        });

        this.$.reading_list.addEventListener('uqlibrary-api-course-reading-list', function(e) {
          if(courseIndex != null) {
            var list = e.detail;
            // sort list by item importance
            var importanceList = {'Required': 1, 'Recommended' : 2, 'Further' : 3};
            list.sort(function(a, b){
              // Item with defined importance should be higher
              if(a.hasOwnProperty('importance') && !b.hasOwnProperty('importance')) {
                return -1;
              }
              // Item with defined importance should be higher
              if(!a.hasOwnProperty('importance') && b.hasOwnProperty('importance')) {
                return 1;
              }
              if(!a.hasOwnProperty('importance') && !b.hasOwnProperty('importance')) {
                return 0;
              }
              var impA = (importanceList.hasOwnProperty(a.importance) ? importanceList[a.importance] : 999);
              var impB = (importanceList.hasOwnProperty(b.importance) ? importanceList[b.importance] : 999);
              return impA-impB;
            });
            if(that.processedCourses[courseIndex]['learning_resources']['reading_lists']){
              that.processedCourses[courseIndex]['learning_resources']['reading_lists']['items'] = e.detail;
            }

          }
        });

        this.$.library_guides.addEventListener('uqlibrary-api-library-guides', function(e) {
          for(var i=0; i < that.courses.length; i++) {
            if(that.courses[i].courseId == that.selectedTab) {
              that.courses[i].library_guides = e.detail;
            }
          }
        });
      },

      get: function(code) {
        if((!code || code =='') && this.processedCourses.length > 0) {
          code = this.processedCourses[0].courseId;
        }
        if(code) {
          for(var i=0; i < this.processedCourses.length; i++) {
            if(this.processedCourses[i].courseId == code) {
              if( !this.processedCourses[i].hasOwnProperty('learning_resources') ){
                this.processedCourses[i]['learning_resources'] = {reading_lists:[], exam_papers: []};
                this.$.learning_resources.get( {code:  code });
              }
              if( !this.processedCourses[i].hasOwnProperty('library_guides') ){
                  this.processedCourses[i]['library_guides'] = [];
                  this.$.library_guides.get( {code: this.processedCourses[i].courseId});
              }
              this.selectedCourse = this.processedCourses[i];
            }

          }
          this.selectedTab = code;
        }
      },

      coursesChanged: function(oldValue, newValue) {
        if(newValue) {
          if(this.courses.length > 0) {
            var termCodes = [];
            for(var i=0; i < this.courses.length; i++) {
              this.courses[i].courseId = this.courses[i].SUBJECT+this.courses[i].CATALOG_NBR;
              if(termCodes.indexOf(this.courses[i].STRM) === -1) {
                termCodes.push(this.courses[i].STRM);
              }
            }

            //sort courses by term
            this.courses.sort(function(a, b) {
              return a.STRM - b.STRM;
            });

            //filter courses to show only current
            var that = this;
            if(termCodes.length > 0) {
              this.$.term_dates.addEventListener('uqlibrary-api-term-dates', function(e) {
                that.termDates = e.detail;
                that.processData();
              });
              this.$.term_dates.get({codes: termCodes});
            }
          }
          else {
            this.processedCourses = [];
            this.fire('uqlibrary-courses-loaded');
          }
        }

      },

      processData: function () {
        this.processedCourses = this.filterCoursesByTerm();
        //Check if there are 2 or more courses with the same code. If found - remove all but the first course
        var _codes = [];

        for( var i=0; i < this.processedCourses.length; i++) {
          if(_codes.indexOf(this.processedCourses[i].courseId) === -1) {
            _codes.push(this.processedCourses[i].courseId);
          }
          else {

            this.processedCourses.splice(i,1);
          }
        }
        this.fire('uqlibrary-courses-loaded');
      },

      selectedTabChanged: function(oldValue, newValue) {
        // check oldValue to prevent load on init
        if(oldValue!= '' && newValue != '') {
          this.get(newValue);
          this.$.ga.addEvent('Course selected', newValue);
        }
      },

      transitioningChangeHandler: function(e) {
        if(e.detail.hasOwnProperty('transitioning'))
          this.transitioning = e.detail.transitioning;
      },
      transitionPrepareHandler: function() {
        this.transitioning = true;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },
      transitionEndHandler: function() {
        this.transitioning = false;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },

      filterReadingLists: function(course) {
        if(course.learning_resources.reading_lists.length == 0){
          return;
        }

        if(course.learning_resources.reading_lists.length == 1) {
          course.learning_resources.reading_lists = course.learning_resources.reading_lists[0];
          return;
        }

        // Filter reading lists to show only list for course semester
        var term = this.getYearSemesterByCode(course.STRM);
        var campus = this.getCampusByCode(course.CAMPUS);

        var semesterString = 'Semester ' + term.semester + ' ' + term.year;
        var found = [];

        for(var i=0; i < course.learning_resources.reading_lists.length; i++) {
          if(course.learning_resources.reading_lists[i].period == semesterString && course.learning_resources.reading_lists[i].campus.indexOf(campus) !== -1) {
            found.push(course.learning_resources.reading_lists[i]);
            //break;
          }
        }

        if(found.length == 0) {
          course.learning_resources.reading_lists = {items: []};
        }
        else if(found.length == 1) {
          course.learning_resources.reading_lists = found[0];
        }
        else {
          course.learning_resources.reading_lists = {items: []};//  course.learning_resources.reading_lists[0];
          course.learning_resources.multipleReadingLists = found;
        }
      },

      filterExamPapers: function(course) {
        for(var i=0; i < course.learning_resources.exam_papers.length; i++) {
          if(course.learning_resources.exam_papers[i].course != course.learning_resources.course_title) {

          }
        }
      },

      filterCoursesByTerm: function(course) {
        if(this.termDates){
          var today = moment();
          var that = this;
          return this.courses.filter(function(course) {
            if(that.termDates.hasOwnProperty(course.STRM)){
              var startDate = moment(that.termDates[course.STRM].begin);
              var endDate = moment(that.termDates[course.STRM].end);
              // show current courses plus courses that starts  in 3 weeks or ended 1 week before
              startDate.subtract(that.termExtendWeeksRange.before, 'weeks');
              endDate.add(that.termExtendWeeksRange.after, 'weeks');
              return (today.isAfter(startDate) && today.isBefore(endDate));
            }
            else return true;
          });
        }
      },

      getReadingListId: function(reading_list) {
        var id = '';
        if(reading_list.hasOwnProperty('url')) {
          var url = reading_list.url;
          id = url.substring(url.lastIndexOf('/') + 1);
          if(id.indexOf('.') !== -1) {
            id = id.substring(0, url.indexOf('.'));
          }
        }
        return id;
      },

      getYearSemesterByCode: function(code) {
        var term = code;
        var year = 2000 + parseInt(((parseInt(term) - 5000 + '').substring(0,2))); // i.e. 6520 - semester 1 year 2015, 6480 - semester 3 year 2014,
        var semester = 1;
        var semesterCode = parseInt(term.substr(-2));
        if(semesterCode >= 50 && semesterCode <= 79) {
          semester = 2;
        }
        if(semesterCode >= 80) {
          semester = 3;
        }
        return {year: year, semester: semester};
      },

      getCampusByCode: function(code) {
        var campuses = {
          "STLUC" : 'St Lucia',
          "GATTN" : 'Gatton',
          "IPSWC" : 'Ipswich',
          "HERST" : 'Herston'
        }
        if(campuses.hasOwnProperty(code)) {
          return campuses[code]
        }
        else return null;


      }

    });
  </script>

</polymer-element>